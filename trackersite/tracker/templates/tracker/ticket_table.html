{% load i18n trackertags %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
<style>
    .container {
        width: 100% !important;
    }
</style>
<script type="text/javascript">

$( document ).ready(function() {
	$( "i" ).each(function() {
		//console.log($( this ).parent().attr("onclick").split("'")[1]);
		if( $( this ).parent().attr("onclick").split("'")[1] == getUrlParameter("order") && getUrlParameter("state") == "1") {
			$( this ).addClass("fa-caret-up");
			console.log("state 1")
		} else if( $( this).parent().attr("onclick").split("'")[1] == getUrlParameter("order") && getUrlParameter("state") == "2") {
			$( this ).addClass("fa-caret-down");
		} else {
			$( this ).addClass("fa-sort");
		}
	});
})
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};

var state = 0;
function order(by) {
    state = getUrlParameter('state');
    if (state == '0') {state = 0;}
    if (state == '1') {state = 1;}
    if (state == '2') {state = 2;}
    if (state == undefined) {
    	state = 0;
    }
    var tmp = getUrlParameter('order'); 
    if (by != tmp && tmp != undefined) {
        state = 0;
    } else if (tmp == undefined) {
     	tmp = by;
	state = 1;
    } else {
	state += 1;
        if (state > 2) {
            state = 0;
        }
    }
    var target = window.location.href.split('?')[0];
    if(state == 1) {
        window.location = target + "?order=" + tmp + "&descasc=asc&state=" + state;
    } else if(state == 2) {
        window.location = target + "?order=" + tmp + "&descasc=desc&state=" + state;
    } else {
        window.location = target;
    }
}
</script>
<table class="ticket_list table table-striped table-hover">
{% if show_media %}
<tr><th rowspan="2">{% trans "ID" %}</th><th rowspan="2">{% trans "Event date" %}</th><th rowspan="2">{% trans "Summary" %}</th>
{% if show_grants %}<th rowspan="2"><abbr title="{% trans "Grant" %}">{% filter slice:":2" %}{% trans "Grant" %}{% endfilter %}<abbr></th>{% endif %}
{% if show_topics %}<th rowspan="2">{% trans "Topic" %}</th>{% endif %}
{% if show_requester %}<th rowspan="2">{% trans "Requested by" %}</th>{% endif %}
<th colspan="3" class="uber-th">{% trans "Media" %}</th>
{% if show_expenses %}<th rowspan="2">{% trans "Expeditures" %}</th>{% endif %}
<th rowspan="2">{% trans "Status" %}</th>
{% if show_expenses %}<th rowspan="2">{% trans "Accepted expeditures" %}</th>{% endif %}
<th rowspan="2">{% trans "Last changed" %}</th></tr>
<tr><th>{% trans "Media item list" %}</th><th><abbr title="{% trans "Item count" %}">{% trans "Itm." %}</abbr></th>
<th><abbr title="{% trans "File count" %}">{% trans "Fil." %}</abbr></th></tr>
{% else %}
<tr><th onclick="order('id')">{% trans "ID" %} <i class="fa "></i></th><th>{% trans "Event date" %}</th><th onclick="order('summary')">{% trans "Summary" %} <i class="fa "></i></th>
{% if show_grants %}<th><abbr title="{% trans "Grant" %}">{% filter slice:":2" %}{% trans "Grant" %}{% endfilter %}<abbr></th>{% endif %}
{% if show_topics %}<th onclick="order('topic')">{% trans "Topic" %} <i class="fa "></i></th>{% endif %}
{% if show_requester %}<th>{% trans "Requested by" %}</th>{% endif %}
{% if show_expenses %}<th>{% trans "Expeditures" %}</th>{% endif %}
<th>{% trans "State" %}</th>
{% if show_expenses %}<th>{% trans "Accepted expeditures" %}</th>{% endif %}
<th onclick="order('updated')">{% trans "Last changed" %} <i class="fa "></i></th></tr>
{% endif %}

{% for ticket in ticket_list %}
<td><a href="{% url "ticket_detail" ticket.id %}">{{ticket.id}}</a></a></td>
<td>{{ticket.sort_date}}</td>
<td><a href="{% url "ticket_detail" ticket.id %}">{{ticket.summary}}</a></td>
{% if show_grants %}<td><a href="{{ticket.topic.grant.get_absolute_url}}" title="{{ticket.topic.grant.full_name}}">{{ticket.topic.grant.short_name}}</a></td>{% endif %}
{% if show_topics %}<td><a href="{{ticket.topic.get_absolute_url}}">{{ticket.topic}}</a></td>{% endif %}
{% if show_requester %}<td>{{ticket.requested_by_html}}</td>{% endif %}

{% if show_media %}
{# media info #}<td>{% for item in ticket.mediainfo_set.all %}{% if item.url %}<a href="{{item.url}}">{{item.description}}</a>{% else %}{{item.description}}{% endif %}{% if item.count %} ({{item.count}}){% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
{# item/file counts #}{% if ticket.media_count.objects > 0 %}<td>{{ticket.media_count.objects}}</td><td>{{ticket.media_count.media|default:""}}</td>{% else %}<td></td><td></td>{% endif %}
{% endif %}
{% if show_expenses %}
{# expeditures #}<td class="money">{% if ticket.expeditures.count > 0 %}{{ticket.expeditures.amount|money}}{% endif %}</td>
{% endif %}

<td>{{ticket.state_str}}</td>
{% if show_expenses %}{% with accepted=ticket.accepted_expeditures %}
<td class="money">{% if accepted > 0 %}{{accepted|money}}{% endif %}</td>
{% endwith %}{% endif %}


<td>{{ticket.updated}}</td></tr>
{% endfor %}

{% if show_media or show_expenses %}{% if summary_item %}
<tr class="total">
<td colspan="{{total_colspan}}">{{total_desc}}</td>
{% if show_media %}
	<td></td>
	{% if summary_item.media_count.objects > 0 %}<td>{{summary_item.media_count.objects}}</td><td>{{summary_item.media_count.media|default:""}}</td>{% else %}<td></td><td></td>{% endif %}
{% endif %}
{% if show_expenses %}
	<td class="money">{% if summary_item.expeditures.count > 0 %}{{summary_item.expeditures.amount|money}}{% endif %}</td>
	<td></td>
	<td class="money">{{summary_item.accepted_expeditures|money}}</td>
	<td colspan="2"></td>
{% else %}
	<td colspan="3"></td>
{% endif %}
</tr>
{% endif %}{% endif %}
</table>
